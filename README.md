# yubikirigennmann

# 業務フロー

### フロー1：新規ユーザー登録 〜 パートナー招待

* **概要：** 新規ユーザー（ユーザーA）が登録し、パートナー（ユーザーB）を招待して、二人のアカウントがアプリ上で紐づくまでの流れです。

```mermaid
graph TD
    subgraph ユーザーA
        A1("開始: アプリ利用") --> A2["情報を入力し、新規登録"]
        A2 --> S1
        S3 --> A3["ダッシュボード表示"] --> A4["パートナーを招待"]
        A4 --> S5
        S6 --> A5["招待リンクをコピーし、<br>LINE等でパートナーに送信"]
    end

    subgraph システム
        S1["[DB] ユーザーA情報を保存<br>(パートナーIDは未設定)"] --> S2["認証トークン(JWT)を発行"] --> S3["Cookieに保存し、ログインさせる"]
        S5["有効期限付きの<br>招待リンクを生成"] --> S6["リンクを画面に表示"]
        B2 --> S7["招待リンクの有効性を検証"]
        S7 -- OK --> S8["[DB] ユーザーB情報を保存"] --> S9["[DB] ユーザーAとBの<br>パートナーIDを相互に紐付ける"] --> S10["使用済み招待リンクを無効化"] --> S11["ユーザーBをログインさせ<br>ダッシュボードへ案内"]
        S9 -.-> S12["(非同期) ユーザーAへ<br>パートナー成立を通知"]
    end

    subgraph ユーザーB
        A5 -.-> B1["受け取った招待リンクを開く"] --> B2["情報を入力し、新規登録"]
        S11 --> B3("完了: パートナーとして<br>利用開始")
    end

    style A1 fill:#B9E6FF
    style B3 fill:#B9E6FF

```
### フロー2：約束の登録から 〜 誓約

* **概要：** 新しい約束を登録し、「誓約書」にサインすることで、二人の間で約束が共有される流れです。
```mermaid
graph TD
    subgraph "約束する人"
        A1("開始: 新しい約束を作成") --> A2["約束の内容・期限を入力"]
        A2 --> A3["「誓約書」にスタンプを押す"]
        A3 --> S1
    end

    subgraph "システム"
        S1["[DB] 約束データを保存<br>(ステータス: 進行中)"] --> S2["(リアルタイム) パートナーの画面に<br>新しい約束を即時表示"]
        S1 -.-> S3["(非同期) パートナーへ<br>新規約束を通知"]
        S2 --> C1("完了")
    end

    subgraph "パートナー"
        S3 -.-> P1["通知を受け取り、<br>内容を確認"]
    end

    style A1 fill:#B9E6FF
    style C1 fill:#B9E6FF
```
### フロー3：約束の評価

* **概要：** システムからの通知をきっかけに、約束された側（評価者）が約束を評価し、その結果が相手（被評価者）に伝わるまでの流れです。
```mermaid

graph TD
    subgraph "システム (定時バッチ/トリガー)"
        T1("開始: 週次 or 約束の期限到来") --> T2["評価者に<br>リマインド通知を送信"]
    end

    subgraph "評価者 (約束された側)"
        T2 --> U1["通知から評価画面へ"]
        U1 --> U2["星評価(1~5)を選択"]
        U2 --> D1{"星2以下か？"}
        D1 -- No --> U4["「思ったこと(感謝など)」<br>を記入"]
        D1 -- Yes --> U3["「改善案」を記入"] --> U4
        U4 --> U5["評価を送信"]
    end

    subgraph "システム (APIサーバー)"
        U5 --> S1["[DB] 評価データを保存"] --> S2["[DB] 約束ステータスを更新"] --> S3["[DB] 信頼スコアを<br>再計算・更新"]
        S3 --> S4["りんごの木のアニメーションを<br>再生させる(実る/枯れる)"]
        S3 -.-> S5["(非同期) 被評価者へ<br>評価完了を通知"]
        S4 --> C1("完了")
    end

    subgraph "被評価者 (約束した側)"
        S5 -.-> E1["評価完了の通知を受け取り、<br>内容を確認"]
    end

    style T1 fill:#B9E6FF
    style C1 fill:#B9E6FF
```
### フロー4：月末の月次レポート

* **概要：** ユーザーの操作を介さず、月末にシステムが自動でその月の活動を集計し、レポートとしてユーザーにフィードバックする流れです。
```mermaid
graph TD
    subgraph "システム (定時バッチ)"
        B1("開始: 月末の深夜") --> B2["[DB] 今月の評価データを集計"]
        B2 --> B3["平均信頼スコアを算出"]
        B2 --> B4["収穫するりんごの総数を計算"]
        B3 & B4 --> B5["月次レポートメールを作成し、<br>両ユーザーに送信"]
        B5 --> B6["[DB] りんごの木の<br>状態をリセット（収穫）"]
        B6 --> C1("完了")
    end

    subgraph "両方のユーザー"
        B5 -.-> U1["月次レポートメールを<br>受け取る"]
    end

    style B1 fill:#B9E6FF
    style C1 fill:#B9E6FF
```
