name: Scheduled Tasks

on:
  schedule:
    # æ¯æ—¥åˆå¾Œ9æ™‚ï¼ˆJSTï¼‰= 12:00 UTC - æœŸæ—¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    - cron: '0 12 * * *'
    # æ¯é€±æ—¥æ›œæ—¥åˆå¾Œ8æ™‚ï¼ˆJSTï¼‰= 11:00 UTC - é€±æ¬¡è©•ä¾¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    - cron: '0 11 * * 0'
    # æ¯æœˆ1æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰= 0:00 UTC - æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ï¼ˆå‰æœˆåˆ†ï¼‰
    - cron: '0 0 1 * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨
    inputs:
      task:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯'
        required: true
        type: choice
        options:
          - all
          - due_date_evaluations
          - weekly_our_promises
          - monthly_reports
        default: 'all'

jobs:
  send-due-date-evaluations:
    name: æœŸæ—¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task == 'all' || github.event.inputs.task == 'due_date_evaluations'))
    
    steps:
      - name: Send due date evaluation emails
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "æœŸæ—¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™"
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${API_URL}/api/scheduled_tasks/send_due_date_evaluations" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æœŸæ—¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ æœŸæ—¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

  send-weekly-evaluation:
    name: é€±æ¬¡è©•ä¾¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 11 * * 0') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task == 'all' || github.event.inputs.task == 'weekly_our_promises'))
    
    steps:
      - name: Send weekly evaluation emails
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "ğŸ“§ é€±æ¬¡è©•ä¾¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${API_URL}/api/scheduled_tasks/send_weekly_our_promises_evaluation" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… é€±æ¬¡è©•ä¾¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ é€±æ¬¡è©•ä¾¡ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Reset our promises for next week
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "ãµãŸã‚Šã®ç´„æŸã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${API_URL}/api/scheduled_tasks/reset_our_promises_for_weekly_evaluation" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… ãµãŸã‚Šã®ç´„æŸã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ ãµãŸã‚Šã®ç´„æŸã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

  send-monthly-reports:
    name: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 0 1 * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task == 'all' || github.event.inputs.task == 'monthly_reports'))
    
    steps:
      - name: Send monthly reports
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${API_URL}/api/scheduled_tasks/send_monthly_reports" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

  notify-on-failure:
    name: å¤±æ•—é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [send-due-date-evaluations, send-weekly-evaluation, send-monthly-reports]
    if: failure()
    
    steps:
      - name: Notify failure
        run: |
          echo "âš ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

